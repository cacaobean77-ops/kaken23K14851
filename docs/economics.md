# Economics & Token Model

本資料では、患者アクセス制御システムにおけるエコノミクス（トークン設計、価格設定、返金ポリシー）について定義します。

## 1. トークンモデル

### 概要
本システムでは、Ethereum (ERC20) 準拠のトークンを使用して、画像提供（COPY）および参照（READ）の対価を支払います。
エスクロー（預託）コントラクト (`PatientAccess.sol`) を介することで、**「対価を支払ったがサービスが提供されない」** リスクを最小化します。

### 使用トークン
- **名称**: MockERC20 (現在のPoC環境)
- **シンボル**: `MOCK`
- **Decimals**: 18
- **ネットワーク**: Localhost (Hardhat Network)

> **Note**: 本番稼働時は、USDC/USDT などのステーブルコイン、または独自ユーティリティトークンの採用を想定しています。

---

## 2. 価格設定 (Pricing)

各提供院 (Provider Clinic) は、自身のデータ提供に対する価格をオンチェーンで設定します。
価格は以下の2種類があります。

| サービス | 説明 | 推奨価格例 |
|----------|------|------------|
| **READ** | DICOM画像の参照権限付与 (Viewerアクセス) | 50 MOCK |
| **COPY** | DICOM画像の複製・転送 (PACS to PACS) | 100 MOCK |

### 動的価格設定 (Future Work)
現在は「1リクエストあたり」の固定価格ですが、将来的には以下のような動的価格設定を検討可能です。
- **データサイズ従量制**: `instances` 数や合計GB単位での課金。
- **モダリティ別**: MRI/CT は高額、CR は低額など。

---

## 3. 支払いフロー (Escrow)

1.  **申請時 (Request)**: Requester（依頼院）は、Providerが設定した価格分のトークンをコントラクトにデポジットします。
2.  **承認時 (Approve)**: 患者が承認しても、この時点ではまだトークンは移動しません。
3.  **提供完了時 (Fulfill)**: Workerが画像をコピーし、`markFulfilled()` を呼び出した時点で、デポジットされたトークンが Provider に送金されます。

---

## 4. 返金ポリシー (Refund Policy)

サービスが提供されなかった場合、Requester はトークンの返金を受けることができます。

### 4.1 自動返金 / 期限切れ (Expiration)
- **条件**: 申請から一定期間（デフォルト: 24時間）経過しても `markFulfilled` が行われなかった場合。
- **アクション**: Requester または患者が `cancelRequest()` を呼び出すことで、ステータスが `EXPIRED/CANCELED` となり、デポジットは全額 Requester に返金されます。

### 4.2 拒否 (Rejection)
- **条件**: 患者が申請を「拒否」した場合。
- **アクション**: 即座にステータスが `CANCELED` となり、全額返金されます。

### 4.3 提供失敗 (Worker Error)
- **条件**: Workerがコピーを試みたが、エラー（Provider Orthancダウン、データ欠損など）で完了できなかった場合。
- **アクション**:
    - Worker は `markFulfilled` を呼び出さないため、最終的に期限切れとなり返金可能です。
    - 将来的には、Worker が明示的に `markFailed()` を呼び出し、即時返金するフローも検討します。

### 4.4 異議申し立て (Dispute) - Future Work
- 画像が破損していた、または別人の画像だった等の場合、オンチェーンでの自動判定は困難です。
- オフチェーンでの異議申し立てプロセス（運営DAOによる裁定など）を経て、補償用にプールされた資金から返金する仕組みを検討中です。
