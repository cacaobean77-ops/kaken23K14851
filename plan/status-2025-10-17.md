# プロジェクトサマリー（2025-10-10）

## プロジェクトの目的
- 患者がオンチェーンでアクセス権を承認し、その承認済みリクエストに対してのみ Provider Orthanc の DICOM 画像を Requester Orthanc へコピー・閲覧できる PoC を構築する。
- スマートコントラクト（PatientAccess）、Worker、Web UI、OHIF Viewer、Orthanc を連携させ、患者承認 → コピー → markFulfilled → ビューア閲覧までを一気通貫で実証する。

## 主要な技術スタック
- ブロックチェーン: Hardhat（Solidity + ethers v6）、MockERC20、PatientAccess コントラクト。
- Worker: Node.js + TypeScript、axios を用いた Orthanc QIDO/WADO/REST、CopyEventStore、監査ログ。
- Web UI: React + Vite、MetaMask 連携、Requester/Patient ダッシュボード、Orthanc ブラウザ。
- ビューア: OHIF v3（Docker）、Orthanc 同梱 OHIF（レガシー UI）。
- インフラ: Docker Compose で Orthanc（provider/requester）・OHIF を起動。Reverse Proxy / VPN の導入を前提にした設計議論済み。

## これまでに決定した仕様
- Worker の `/secure/*` で requestId が `PATIENT_APPROVED` 以上かつ許可された Requester clinic かをオンチェーンで検証し、JSONL 形式の監査ログを `gateway-audit.jsonl` に記録する。
- `GET /dicom-web-config` で OHIF が期待する `servers.dicomWeb` JSON を返却し、Basic 認証情報も含めて提供する。`VITE_OHIF_USE_PROXY=true` で `viewer/dicomwebproxy` を使う構成に切り替え可能。
- `.env.local` の `VITE_ORTHANC_BASE_RQ` は `/secure` を指し、UI からの Orthanc アクセスはすべて Worker 経由で行う。`VITE_WORKER_API` が必須。
- Provider Worker 案も検討し、clinicId → 接続先解決は Provider 側で署名された設定 or オンチェーンレジストリで行う方針。
- Orthanc 同梱 OHIF を利用する場合は `ohif/app-config.js` をマウントし、DICOMweb ルートを `http://localhost:8043/dicom-web` に固定。
- 逆プロキシ（例: Nginx）と ID 管理（Keycloak など）を組み合わせ、アクセス制御を一元化する方向で合意。

## 実装済みの機能
- Worker: CopyEventStore・REST フォールバック・指数バックオフ・`/secure/{requestId}/…` のパス対応・マルチオリジン CORS・`/dicom-web-config` 追加。
- Web UI: Requester Orthanc ブラウザの Worker 経由アクセス化、OHIF リンク生成の切替 (`viewer/dicomwebproxy` / 直接アクセス)、CopyEvent 通知パネル。
- ドキュメント: README / plan 更新（リバースプロキシ・ID 連携・旧 OHIF の手順など）、`.env.local` のテンプレ更新。
- Docker: orthanc_requester コンテナへ `ohif/app-config.js` をマウントし、旧 OHIF UI で DICOMweb を利用可能にした。

## 現在の課題または次に取り組むべきタスク
- OHIF v3 の Study List が 0 件になる場合の検証と UI 設定（フィルター管理）改善。必要なら初期フィルターをリセットする仕組みを導入。
- Provider 主導で Worker を運用する（Push 型）場合の接続情報レジストリ・署名検証の実装検討。
- リバースプロキシ／認証基盤（Keycloak 等）との実装統合。Worker API への JWT 連携や役割ベースアクセス制御を設計する。
- Worker 設定の改竄対策：Provider が署名した `config` の検証、オンチェーンでの許可リスト参照、VPN/IP 制限の具体化。
- 大容量転送や暗号化ストレージを含むエンドツーエンドのデータ保護（転送中・保存中の暗号化、削除ポリシー）を整備する。
