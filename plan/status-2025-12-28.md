# プロジェクトサマリー（2025-12-28）

## プロジェクトの目的
- 患者がオンチェーンでアクセス権を承認し、その承認済みリクエストに対してのみ Provider Orthanc の DICOM 画像を Requester Orthanc へコピー・閲覧できる PoC を構築する。
- スマートコントラクト（PatientAccess）、Worker、Web UI、OHIF Viewer、Orthanc を連携させ、患者承認 → コピー → markFulfilled → ビューア閲覧までを一気通貫で実証する。

## 主要な技術スタック
- ブロックチェーン: Hardhat（Solidity + ethers v6）、MockERC20、PatientAccess コントラクト。
- Worker: Node.js + TypeScript、axios を用いた Orthanc QIDO/WADO/REST、CopyEventStore、監査ログ。
- Web UI: React + Vite、MetaMask 連携、Requester/Patient ダッシュボード、Orthanc ブラウザ。
- ビューア: OHIF v3（Docker）、Orthanc 同梱 OHIF（レガシー UI）。
- インフラ: Docker Compose で Orthanc（provider/requester）・OHIF を起動。Reverse Proxy (Nginx) の導入済み。

## これまでに決定した仕様
- Worker の `/secure/*` で requestId が `PATIENT_APPROVED` 以上かつ許可された Requester clinic かをオンチェーンで検証し、JSONL 形式の監査ログを `gateway-audit.jsonl` に記録する。
- `GET /dicom-web-config` で OHIF が期待する `servers.dicomWeb` JSON を返却し、Basic 認証情報も含めて提供する。
- `.env.local` の `VITE_ORTHANC_BASE_RQ` は `/secure` を指し、UI からの Orthanc アクセスはすべて Worker 経由で行う。
- Provider Worker は `orthanc` モード（Pull型）を採用し、Worker が Provider Orthanc から自動的に画像を取得・コピーする。
- 逆プロキシ（Nginx）を導入し、アクセス制御を一元化。

## 実装済みの機能（2025-12-28 更新）
- **自動化スクリプト**: `setup_first.sh`, `start_stack.sh` など、ワンコマンドで環境構築・起動・停止が可能になった。
- **ドキュメント強化**: `README.md` にテスト用アカウント情報や Keycloak 認証情報を追加。
- **Provider Push 自動化**: Worker の `copy.mode` を `orthanc` (Pullモード) に設定し、患者承認後に自動的に画像をコピー・完了報告するフローを確立。
- **署名機能の改善**: Worker (`SignerClient`) が秘密鍵 (`privateKey`) による直接署名をサポート。
- **エンドツーエンド検証**: 申請 → 承認 → 自動コピー → トークン決済のフロー動作を確認済み。
- **CI/CD & 品質管理**: GitHub Actions による CI パイプライン、ESLint 導入、E2E テストスクリプト (`tests/e2e/run-flow.sh`) を整備。
- **データ保護 (New!)**: Worker の HTTPS 対応、監査ログの AES-256-GCM 暗号化、および自動削除ポリシー (`CleanupService`) を実装。
- **バグ修正 & 安定性向上 (New!)**:
    - `stop_stack.sh` がゾンビプロセス（ポート8787占有）を強制終了するように修正。
    - Worker が起動時に過去（1000ブロック分）のイベントをスキャンし、ダウン中の承認も見逃さないように改善。
    - OHIF Viewer からの CORS エラーを修正（`http://localhost` 許可）。
- **Git/GitHub 整備 (New!)**: `.gitignore` の整備と `blockchain-projectAG` へのコードアップロード完了。

## 現在の課題または次に取り組むべきタスク
- **認証の再有効化 (Current Issue)**: 現在、一時的な回避策として Worker の認証を無効化 (`auth.enabled: false`) している。Keycloak との連携を再確認し、認証を有効に戻す必要がある。
- **Worker設定のセキュリティ**: 設定改竄対策（Provider署名、オンチェーン許可リスト、VPN/IP制限など）を実装する。
- **Operator Security**: Operator権限のマルチシグ化（Gnosis Safe等）を検討する。
- **Network**: L2テストネット（Base Sepoliaなど）へのデプロイ検証。
- **実環境連携**: 本物のPACSやIdP（OIDC）との連携テスト。

## 詳細 To-Do リスト (from TODO.md)

### 1. 直近の課題 & UI/UX (優先度高)
- [x] **OHIF v3 Study List 検証**: Study Listが0件になる問題を調査し、UI設定（フィルター管理）を改善する。（`ohif/app-config.js` に自動クリア処理を追加）
- [x] **OHIF CORS 対応**: `worker/config.json` の `corsOrigin` に `http://localhost` を追加し、接続エラーを解消。
- [x] **Requester UI アラート**: Requester UIのアラートをSlackやPagerDutyへ連携する。（`worker/alert-service.ts` 実装済み）

### 2. インフラ & セキュリティ (Worker/Gateway)
- [x] **リバースプロキシ & 認証統合**: Nginx および Keycloak と統合完了。（`docs/auth-setup.md` 参照）
- [ ] **Worker認証の修正**: `auth.enabled: true` に戻し、401エラーを恒久的に解消する。
- [ ] **Worker設定のセキュリティ**: 設定改竄対策（Provider署名、オンチェーン許可リスト、VPN/IP制限など）を実装する。
- [x] **Provider主導Worker（プッシュ型）**: `orthanc` モードと `privateKey` 署名対応により自動化完了。
- [x] **SCM/Ops改善**: 起動スクリプト (`start_stack.sh`) の整備完了。ゾンビプロセス対策も実装済み。
- [x] **GitHub Upload**: プロジェクト一式を `blockchain-projectAG` にアップロード済み。
- [x] **ゲートウェイ監査ログ**: `gateway-audit.jsonl` のローテーションと集中管理。（`worker/index.ts` 実装済み）
- [x] **データ保護**: 転送中(HTTPS)・保存中(ログ暗号化)の保護と、不要ログの自動削除ポリシーを実装。

### 3. CI/CD & 品質保証
- [x] **CIパイプライン**: `.github/workflows/ci.yml` 実装済み。
- [x] **自動テスト**: `docs/access-control.md` 作成、`tests/e2e/run-flow.sh` 実装、`README` にテスト手順追加完了。

### 4. ロードマップ & 機能拡張 (Features)
- [x] **Economics**: トークンモデル、価格、返金ポリシーの策定完了。（`docs/economics.md` 作成済み）
- [x] **Audit Logs**: 監査ログの集計・可視化ビュー作成完了。
- [ ] **Operator Security**: Operator権限のマルチシグ化（Gnosis Safe等）を検討する。
- [ ] **Network**: L2テストネット（Base Sepoliaなど）へのデプロイと実環境IdP/PACSとの接続検証。
- [ ] **実環境連携**: 本物のPACSやIdP（OIDC）と連携する。
