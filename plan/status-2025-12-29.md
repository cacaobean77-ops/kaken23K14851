# プロジェクトサマリー（2025-12-29）

## プロジェクトの目的
患者がオンチェーンでアクセス権を承認し、承認に基づき Provider Orthanc の DICOM 画像を Requester Orthanc へ安全にコピー・閲覧できる PoC を構築する。

## 主要な更新項目 (2025-12-29)

### 1. 動的なクリニック設定と管理 (Worker/WebUI)
- **ClinicStore**: Worker 側に `worker/dicom-config.json` を用いた永続化ストアを実装。静的な `config.json` を上書きまたは補完する形で、動的にプロバイダー設定（QIDO/WADO URL, 認証情報）を追加可能にした。
- **Clinic Config API**: `GET|PUT|DELETE /clinics/config` を実装。管理者が Web UI から接続先を追加・編集できるようになった。

### 2. アクセス制御の強化 (Security)
- **RBAC & Ownership**: Worker API において、`worker.admin` ロールまたは JWT クレームの `clinic_id` に基づくアクセス制御を実装。
    - ユーザーは自身の `clinic_id` に紐づく設定のみを編集可能。
    - 管理者(`worker.admin`)は全クリニックの設定を操作可能。

### 3. オンチェーン・クリニックリスト (WebUI)
- **On-Chain Clinic List**: スマートコントラクトの `ClinicRegistered` イベントを収集し、ブロックチェーン上に登録されている全クリニック（ID, Payout, Operator, KeyHash）を一覧表示するポップアップ画面を実装。

### 4. Web UI の改善 (UI/UX)
- **タブ構成へのリファクタリング**: `App.tsx` を「Patient」「Requester」「Settings & Admin」の3タブ構成に刷新。役割ごとの操作性を向上させた。
- **代替ビューアリンク**: OHIF Viewer が不安定な場合（Study List 0件問題）のフォールバックとして、ネイティブの **Orthanc Explorer** への直接リンクを追加。また、他のビューア用に **Study Instance UID** を明示的に表示するようにした。

## 現在の課題 (Current Issues)

1. **OHIF Viewer の安定性**:
    - Study List が空になる現象が散見される。`app-config.js` の調整等を行っているが、完全な解決には至っていないため、Orthanc Explorer へのリンクを回避策としている。

2. **認証の完全適用**:
    - Worker の認証 (`auth.enabled`) は現在一時的に無効化または開発モードで運用されているケースがある。本番運用に向けて Keycloak 連携を `true` に戻し、RBAC を厳密にテストする必要がある。

3. **スマートコントラクト**:
    - クリニック一覧を取得する `getAllClinics` のような View 関数がないため、フロントエンドでイベントログを集計している。運用規模が大きくなるとパフォーマンスに影響するため、The Graph 等の Indexer 導入やコントラクト改修が将来的に必要になる可能性がある。

## 次に取り組むべきタスク (Next Steps)

### 短期 (Priority: High)
- [ ] **Worker認証の再有効化**: `worker/config.json` の `auth.enabled: true` 化と動作検証。
- [ ] **E2E テストの拡充**: 新設した `/clinics/config` API やアクセス制御ロジックの自動テスト追加。

### 中期 (Priority: Medium)
- [ ] **実環境連携**: テストネット (Base Sepolia等) へのデプロイと、実際の PACS/IdP との接続検証。
- [ ] **セキュリティ強化**: Provider 署名の検証強化、Worker 設定ファイルの改竄検知（署名付き設定ファイル等）。

## 開発環境メモ
- **最新コード**: `blockchain-projectAG` リポジトリの `main` ブランチ。
- **起動**: `./start_stack.sh` で全スタック起動。
- **Web UI**: `http://localhost:5173`
- **確認**: `./status_stack.sh`
