# プロジェクトサマリー（2025-10-03）

## プロジェクトの目的
- 患者がオンチェーンでアクセス権を承認し、その承認に従って Provider Orthanc の DICOM 画像を Requester Orthanc へ安全にコピー・閲覧できる PoC を構築する。
- スマートコントラクト（PatientAccess）、Worker、Web UI、OHIF Viewer を連携させ、患者承認 → コピー → markFulfilled → ビューア閲覧までの一連フローを実証する。

## 主要な技術スタック
- ブロックチェーン: Hardhat (Solidity + ethers)、MockERC20、PatientAccess コントラクト。
- バックエンド/Worker: Node.js + TypeScript、axios による Orthanc QIDO/WADO/REST 操作、イベントポーリング、ゲートウェイ API。
- フロントエンド: React + Vite、ethers v6、MetaMask 連携、Tailwind 風ユーティリティ。
- DICOM インフラ: Orthanc (Provider/Requester) + OHIF Viewer、Docker Compose 運用。

## これまでに決定した仕様
- `deploy:localhost` 完了時に Web/.env と worker/config を自動同期し、PROV/REQ 双方のクリニック・operator 情報を注入する。
- Requester Orthanc は Basic 認証を有効化し、Worker ゲートウェイ (`/secure/...`) を経由したアクセスのみ許可する。
- Worker ゲートウェイは `requestId` を必須とし、PatientAccess のステータスが `PATIENT_APPROVED` 以上かつ管理対象 requester であることを確認したうえで Orthanc にプロキシする。
- OHIF 起動時にはゲートウェイ URL + `requestId` 付きの DICOMweb を使用し、資格情報 (`orthanc/orthanc`) をクエリで渡す。
- プロバイダーの価格設定は Web UI から行い、MetaMask 上で operator/payout アカウントのみが `setPrice` を実行できるようにする。

## 実装済みの機能
- Provider 設定 UI（`ProviderSettings`）を新設し、価格表示・ERC20 メタ取得・`setPrice` 送信・再取得までをワンストップで実行可能にした。
- Worker API を `/secure/*` プロキシ仕様に拡張し、Orthanc への REST / DICOMweb リクエストに対して `requestId` 検証とレスポンス再整形（Content-Length 除去など）を実装。
- Requester Orthanc の Basic 認証化と OHIF 側の認証設定追加、Web UI の Orthanc ブラウザを requestId 入力必須 + ゲートウェイ経由に改修。
- `deploy.ts` が `worker/config.json` と `webapp/.env.local` を自動更新し、PROV/REQ 登録・トークンアドレス・ゲートウェイ URL などを最新状態に保つ。
- Worker の REST フォールバックと manifest ハッシュ生成、`alias-map.json` 永続化、Basic 認証付き QIDO/WADO のリトライ機構は継続利用中。
- `/secure/*` へのアクセスは `worker/gateway-audit.jsonl` に requestId / patientId / status / error を JSON Lines で記録し、失敗理由も含めて永続化できるようにした（`audit.file` で保存先を変更可能）。
- Worker がコピー結果を `CopyEventStore` で保持し、`GET /copy-events` API 経由で成功/失敗数・失敗 SOP を提供。Requester UI はこれをポーリングして部分失敗/エラー通知を表示するよう更新。
- OHIF 用に `GET /secure/{requestId}/…` 形式のパス指定をサポートし、DICOMweb ルートにクエリを含めなくても Study List が取得できるよう整備。
- `GET /dicom-web-config` を追加し、OHIF の DICOMweb Proxy 機能から `servers.dicomWeb` 設定を受け取れるようにした（Basic 認証情報も含めて返却）。

## 現在の課題または次に取り組むべきタスク
- ゲートウェイ監査ログ（JSONL）のローテーション/集中管理（ELK/SIEM 連携）と集計ビュー整備。
- Requester UI からのアラートを Slack / PagerDuty など外部通知へ連携する設計（Worker の `copy-events` 結果を webhook 化）。
- CI パイプライン整備 (`npm run test`、`hardhat test`、`eslint`) と自動化手順のドキュメント化。
- セキュリティ強化（Operator 権限のマルチシグ化、alias 管理の権限分離、残る OHIF 認証フローの最適化）。
- 新しいアクセス制御仕様のシーケンス図と自動テスト（doc + e2e チェックリスト）を追加する。
