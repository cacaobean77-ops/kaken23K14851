# OHIF StudyList 調査メモ（2025-09-27）

## プロジェクトの目的
- 患者がブロックチェーン上でアクセス権を承認し、Orthanc 間で DICOM 画像を安全に転送・閲覧できる PoC を構築する。
- スマートコントラクト／ワーカー／UI を連携させ、患者承認 → コピー → markFulfilled までの一連フローを実現する。

## 主要な技術スタック
- Hardhat + Solidity + ethers.js（スマートコントラクト）
- Node.js / TypeScript（Worker）
- React + Vite + MetaMask 連携（Web UI）
- Orthanc ×2（Provider / Requester）と OHIF Viewer（Docker）
- Docker Compose で Orthanc/OHIF を起動

## これまでに決定した仕様
- Hardhat の `deploy:localhost` と `export-abi` で `webapp/.env.local` と `worker/config.json` のアドレスを自動同期。
- Worker は QIDO→WADO→markFulfilled、REST フォールバックや `manifestHash` 生成も実装済み。
- Web UI は Requester/Patient 双方にトランザクション状態表示を備え、開発時は Vite プロキシ越しに Orthanc へ接続する。
- OHIF 用 `app-config.js` はクエリや localStorage で DICOMweb 接続先を切り替え可能。
- Hardhat デプロイ時に Requester オペレーターへ ERC20 allowance を自動付与。

## 実装済みの機能
- Requester → 患者承認 → Worker コピー → `markFulfilled` → OHIF 閲覧までの手動確認済み。
- Worker `logLevel` 切替・REST フォールバック成功ログ・`markFulfilled confirmed` まで出力される。
- DICOM ファイル `POST /instances` の手動テスト成功（Basic 認証含む）。
- Docker Compose で Orthanc/OHIF が稼働、`docker compose ps` で状態確認可能。

## 現在の課題 / 次に取り組むべきタスク
- OHIF の Study List が 0 件のまま（CSP/キャッシュ対策後も `/dicom-web/studies` リクエストが発生しない）。
- Network タブで `/dicom-web/studies` を取得できない原因の特定（ビュー遷移、サービスワーカー無効化、CSP 切り替えを継続調査）。
- 派生タスク例: Requester UI のステータス一覧可視化、Worker の `manifestHash` 規約整理、aliasResolver UI 管理機能、CI パイプライン整備など。

