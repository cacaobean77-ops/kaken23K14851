# プロジェクトサマリーメモ（Codex作成）

## プロジェクトの目的
- 患者がブロックチェーン上でアクセス権を承認し、Orthanc 間で DICOM 画像を安全に転送・閲覧できる PoC を構築する。
- スマートコントラクト・Web UI・Worker・OHIF ビューアを連携させ、患者承認→コピー→清算までのフローを実証する。

## 主要な技術スタック
- バックエンド/ブロックチェーン: Hardhat (Solidity + ethers.js)、MockERC20、PatientAccess コントラクト。
- ワーカー: Node.js / TypeScript、axios を用いた Orthanc DICOMweb/REST 操作、リトライ&バックオフ実装、エイリアス管理 API。
- フロントエンド: React + Vite、ethers v6、MetaMask 連携、患者/Requester UI コンポーネント、Tailwind 風ユーティリティクラス。
- DICOM インフラ: Orthanc (Provider/Requester) + OHIF Viewer、Docker Compose 管理。

## これまでに決定した仕様
- `deploy:localhost` → `export-abi` 実行で `.env.local` と `worker/config.json` を最新アドレスに同期。
- Requester/Provider の Clinic 登録、価格設定、MockERC20 の払い出し＆Allowance 自動付与。
- Worker は `PatientApproved` をポーリングし、QIDO → WADO/REST コピー後 `markFulfilled`、部分成功時は JSON 形式で manifest ハッシュ化。
- エイリアス (ウォレット ↔ 患者ID) は Worker の HTTP API (`/aliases`) を単一真実源とし、UI から登録・削除可能。
- フロントの Requester ダッシュボードは直近10件のバッチ進捗をポーリング表示、価格と Allowance/Balances を一覧化する。

## 実装済みの機能
- Requester ダッシュボード: 価格表示、Allowance/残高確認、子リクエスト状態の自動更新、患者ID入力→ウォレット解決、申請ID表示。
- 患者ポータル: 申請ID入力による承認/キャンセル、トランザクション状態表示。
- Worker: REST フォールバック、指数バックオフリトライ、部分成功 manifest ハッシュ、エイリアス API サーバ、persistent alias-map。
- Alias 管理 UI: Worker API と連携し、ウォレット ↔ 患者ID を CRUD、即時リロード。
- デプロイスクリプト: MockERC20 & PatientAccess 再デプロイ、価格設定、Allowance 自動化、同期スクリプトによる環境変数更新。
- 同期後のフロー確認: 患者ID入力→申請→患者承認→Worker 履行まで一連動作を再度手動確認済み。

## 現在の課題または次に取り組むべきタスク
- OHIF Study List が 0 件になる事象の根本原因調査（ネットワーク/サービスワーカー/CSP など）と再発防止策の実装。
- Requester UI / Worker のログ・エラー通知を整理し、部分失敗時の可観測性とリカバリ導線を強化する。
- CI パイプラインの整備（`npm run test`、`hardhat test`、`eslint` の自動実行）。
- セキュリティ強化: Operator のマルチシグ化、監査ログ集計ビューの整備、エイリアス管理の拡張（履歴・権限管理）。
- 本番準備事項: L2 テストネット対応、OIDC 等の IdP 連携、本番 PACS との接続要件、価格/返金ポリシー・失効処理設計。
